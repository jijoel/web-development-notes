Tuesday, 3 March 2015
=====================
I'm working with Stripe today, and finding something weird. I'm trying to save a model based on Stripe data, but it's not storing the id...

    $new = new StripeCharge;
    var_dump('charge:'.$charge->id);
    var_dump('before:'.$new->id);
    $new->id = $charge->id;
    var_dump('after:'.$new->id);

Gives me this:

    string 'charge:ch_...' (length=34)
    string 'before:' (length=7)
    string 'after:ch_...' (length=33)
    string 'final:0' (length=7)

Why would my Laravel model be losing the charge id on save? And, why would no error be thrown?

The query log looks fine. The id is correctly set in the table. Why isn't Laravel picking it up?

Unknown... but it does go into the table correctly. I can search for it, and return the (found) object. I can be sure that an object was created by using Model::findOrFail($charge->id)


Wedesday, 4 March 2015
=======================
Can we do unit testing for model attributes that are dependent on a relationship? We'd need to make a partial mock...

It does work, but is a little tricky. The name attribute looks like this:

```php
    public function getNameAttribute()
    {
        foreach(['metadata','cards'] as $type)
            foreach($this->$type as $data)
                if ($data->key == 'name')
                    return $data->value;

        return '';
    }
```

The tests look like this:

```php
    /**
     * @dataProvider getNameDataSources
     */
    public function testCanGetName($metadata, $cards, $expected)
    {
        $metaMock = $this->createRelationMock($metadata);
        $cardMock = $this->createRelationMock($cards);

        $test = Mockery::mock('StripeCustomer[metadata,cards]')
            ->shouldReceive('metadata')->andReturn($metaMock)
            ->shouldReceive('cards')->andReturn($cardMock)
            ->getMock();

        $this->assertSame($expected, $test->name);
    }

    public function getNameDataSources()
    {
        return array(
            array([],[],''),
            array(
                [ MockObject::mock('x',['key'=>'name','value'=>'x'])],
                [],
                'x',
            ),
            ...
        );
    }

    protected function createRelationMock($return)
    {
        $relation = 'Illuminate\Database\Eloquent\Relations\Relation';

        return Mockery::mock($relation)
            ->shouldReceive('getResults')
            ->andReturn($return)
            ->getMock();
    }
```

