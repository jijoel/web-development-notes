Tuesday, 14 April 2015
======================
What is the best way to handle configuration in Laravel packages? I keep running into this question; it's time to come up with a really good solution.

I like how Barryvdh\Snappy works:

```php
    public function register()
    {
        $this->package('barryvdh/laravel-snappy');

        if($this->app['config']->get('laravel-snappy::config.pdf.enabled')){
            $this->app['snappy.pdf'] = $this->app->share(function($app)
            {
                $binary = $app['config']->get('laravel-snappy::config.pdf.binary');
                $options = $app['config']->get('laravel-snappy::config.pdf.options');
                $timeout = $app['config']->get('laravel-snappy::config.pdf.timeout', false);

                $snappy = new IlluminateSnappyPdf($app['files'], $binary, $options);
                if (false !== $timeout) {
                    $snappy->setTimeout($timeout);
                }

                return $snappy;
            });
```

The config file looks like this:

```
    return array(
        'pdf' => array(
            'enabled' => true,
            'binary' => '/usr/local/bin/wkhtmltopdf',
            'timeout' => false,
            'options' => array(),
        ),
```

So I could set a default config file... and have Laravel4 and Laravel5 service providers to access it...

But how do I actually access it? 

For some reason, my config file is not being loaded. Where is it looking? (My package is PSR-4...)



Wednesday, 15 April 2015
========================

Hmmm... I really need to figure out how to load config data. 

    dd(Config::get('local-stripe::keys'));

is not working at all. It's giving me a null value. Theoretically, it should give me an array. I was able to publish the config file by using 

    php artisan config:publish kumuwai/local-stripe

In my sample Laravel 4 app, it publishes the file to:

    app/config/packages/kumuwai/local-stripe/config.php

It's still giving me a null value, though...

Because it publishes the file, I believe that it's in the right place, and should be loaded. In http://laravel.com/docs/4.2/, it says:

    Retrieving A Package Configuration Item

    return Config::get('package::group.option');

... which is exactly what I have. I've also tried     

    dd(Config::get('local-stripe::config.keys'));

Let's find out how the config system works. It looks like it pulls data from a FileLoader class... It tries to find the path of the file. It's returning Null for my file...

It sees local-stripe as a namespace. Is this because I'm using psr-4?

Ahhhh.... It's because my service provider directory is one level down. I have this:

    src/
        /config/config.php
        /Laravel/Laravel#ServiceProvider.php

So, in the service provider, I need to tell it which directory to use:

    $this->package('kumuwai/local-stripe', null, __DIR__.'/..');

Once I've done that, I can access it like this:

    $secret = $app['config']->get('local-stripe::keys.secret', getenv('STRIPE_SECRET'));

Laravel 5 is a bit easier. Publish the name of the config file you want to use, and then merge it with the default:

    $this->publishes([
        realpath(__DIR__.'/../config/config.php') => config_path('local-stripe.php')
    ], 'config');

    $this->mergeConfigFrom(__DIR__.'/../config/config.php', 'local-stripe');

I can then access it like this:

    $secret = $app['config']->get('local-stripe.keys.secret', getenv('STRIPE_SECRET'));

So, a service provider in Laravel 4:

```php
class Laravel4ServiceProvider extends ServiceProvider 
{
    protected $defer = true;

    public function boot()
    {
        $this->package('kumuwai/local-stripe', null, __DIR__.'/..');
    }

    public function register()
    {
        $this->boot();

        $this->app['local-stripe'] = $this->app->share(function($app){
            $secret = $app['config']->get('local-stripe::keys.secret',getenv('STRIPE_SECRET'));
            return new LocalStripe($secret);  // for instance
        });
    }

    public function provides()
    {
        return array('local-stripe');
    }
}
```

And the equivalent in Laravel 5:

```
class Laravel5ServiceProvider extends ServiceProvider 
{
    protected $defer = true;    // only load if/when needed

    public function boot()
    {
        $this->publishes([
            realpath(__DIR__.'/../migrations') => $this->app->databasePath().'/migrations'
        ], 'migrations');

        $this->publishes([
            realpath(__DIR__.'/../config/config.php') => config_path('local-stripe.php')
        ], 'config');
    }

    public function register()
    {
        $this->mergeConfigFrom(__DIR__.'/../config/config.php', 'local-stripe');

        $this->app['local-stripe'] = $this->app->share(function($app){

            $secret = $app['config']->get('local-stripe.keys.secret',getenv('STRIPE_SECRET'));
            return new LocalStripe($secret);  // for instance
        });
    }

    public function provides()
    {
        return array('local-stripe');
    }
}
```

